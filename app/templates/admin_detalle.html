<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Video</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_detalle.css') }}">
</head>
<body>
    <div class="container fade-in">
        <div class="header-with-logo">
            <h2>Detalle del video</h2>
        </div> 

        <div class="video-info slide-in">
            <div class="info-card">
                <div class="info-label"><i class="fas fa-user"></i> Usuario</div>
                <div class="info-value">Usuario {{ video.usuario_id }}</div>
            </div>
            <div class="info-card">
                <div class="info-label"><i class="fas fa-calendar-alt"></i> Fecha de carga</div>
                <div class="info-value">{{ video.fecha_subida.strftime('%Y-%m-%d %H:%M') if video.fecha_subida else 'Sin fecha' }}</div>
            </div>
            <div class="info-card">
                <div class="info-label"><i class="fas fa-file"></i> Archivo</div>
                <div class="info-value">{{ video.nombre_archivo }}</div>
            </div>

            <!-- Estado IA centralizado -->
            <div class="info-card">
                <div class="info-label"><i class="fas fa-robot"></i> Estado IA</div>
                <div class="info-value">
                    {% set ia_status = video.get_moderation_status() %}
                    <span class="status-badge status-{{ ia_status.color }}">{{ ia_status.text }}</span>
                </div>
            </div>

            <!-- Estado administrativo -->
            <div class="info-card">
                <div class="info-label"><i class="fas fa-user-check"></i> Estado administrativo</div>
                <div class="info-value" id="admin-status">
                    {% if video.estado == 'aceptado' %}
                        <span class="status-badge status-accepted">Aceptado</span>
                    {% elif video.estado == 'rechazado' %}
                        <span class="status-badge status-rejected">Rechazado</span>
                    {% else %}
                        <span class="status-badge status-pending">Pendiente de revisión</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Reproductor -->
        <div class="video-wrapper">
            <video id="player" data-video-id="{{ video.id }}" controls src="{{ signed_url or video.video_url }}"></video>
        </div>

        <!-- Descripción -->
        {% if video.descripcion and video.descripcion != 'Sin descripción proporcionada' %}
        <div class="description-section slide-in">
            <div class="section-title"><i class="fas fa-file-alt"></i> Descripción</div>
            <div class="description-content">{{ video.descripcion }}</div>
        </div>
        {% endif %}

        <!-- Análisis IA -->
        <div class="analysis-section slide-in">
            <div class="section-title"><i class="fas fa-brain"></i> Análisis de inteligencia artificial</div>

            {% if video.estado_ia == 'completado' %}
                {% set visual_status = video.get_moderation_status() %}
                {% set safety = video.get_safety_score() %}

                <div class="analysis-item-full moderation-summary">
                    <div class="summary-box">
                        <div class="summary-title"><i class="fas fa-eye"></i> Análisis Visual</div>
                        <div class="summary-value">
                            <span class="status-badge status-{{ visual_status.color }}">{{ visual_status.text }}</span>
                        </div>
                    </div>
                    <div class="summary-box">
                        <div class="summary-title"><i class="fas fa-spell-check"></i> Análisis de Texto</div>
                        <div class="summary-value">
                            {% if video.nivel_problema_texto == 'problematico' %}
                                <span class="status-badge status-danger">Problemático</span>
                            {% elif video.nivel_problema_texto == 'sospechoso' %}
                                <span class="status-badge status-warning">Sospechoso</span>
                            {% else %}
                                <span class="status-badge status-success">Limpio</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="verdict">
                        Veredicto IA:
                        <span class="badge-verdict status-{{ visual_status.color }}">{{ visual_status.text }}</span>
                        {% if visual_status.reason %}
                            <small class="verdict-reason">({{ visual_status.reason }})</small>
                        {% endif %}
                    </div>
                </div>

                <!-- Detalles secundarios -->
                <div class="analysis-grid" style="margin-top: 1.5rem;">
                    <div class="analysis-item-full">
                        <div class="analysis-label"><i class="fas fa-shield-virus"></i> Puntaje de Seguridad</div>
                        <div class="analysis-value">
                            <div class="confidence-bar">
                                <div class="confidence-fill confidence-fill-{{ safety.color }}" style="width: {{ safety.score }}%"></div>
                                <span class="confidence-text">{{ safety.score }}%</span>
                            </div>
                        </div>
                    </div>

                    <div class="analysis-item">
                        <div class="analysis-label"><i class="fas fa-tags"></i> Etiquetas ({{ video.etiquetas.split(',')|length if video.etiquetas else 0 }})</div>
                        <div class="analysis-value">
                            {% if video.etiquetas %}
                                <div class="tags-container">
                                    {% for etiqueta in video.etiquetas.split(',') %}
                                        <span class="tag">{{ etiqueta.strip() }}</span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <span class="no-data">Sin etiquetas detectadas</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="analysis-item">
                        <div class="analysis-label"><i class="fas fa-flag"></i> Palabras Problemáticas</div>
                        <div class="analysis-value">
                            {% if video.palabras_problematicas_texto %}
                                <div class="tags-container">
                                    {% for palabra in video.palabras_problematicas_texto.split(',') %}
                                        <span class="problematic-tag">{{ palabra.strip() }}</span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <span class="no-data">Ninguna</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="analysis-item">
                        <div class="analysis-label"><i class="fas fa-copyright"></i> Logotipos</div>
                        <div class="analysis-value">
                            {% if video.logotipos %}
                                <div class="tags-container">
                                    {% for logo in video.logotipos.split(',') %}
                                        <span class="tag">{{ logo.strip() }}</span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <span class="no-data">No se detectaron logotipos</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="analysis-item">
                        <div class="analysis-label"><i class="fas fa-clock"></i> Duración</div>
                        <div class="analysis-value">{{ "%.1f"|format(video.duracion|float) }} segundos</div>
                    </div>

                    <div class="analysis-item">
                        <div class="analysis-label"><i class="fas fa-stopwatch"></i> Tiempo de procesamiento</div>
                        <div class="analysis-value">{{ "%.1f"|format(video.tiempo_procesamiento|float) }} segundos</div>
                    </div>

                    {% if video.fecha_procesamiento %}
                    <div class="analysis-item">
                        <div class="analysis-label"><i class="fas fa-calendar-check"></i> Procesado el</div>
                        <div class="analysis-value">{{ video.fecha_procesamiento.strftime('%Y-%m-%d %H:%M') }}</div>
                    </div>
                    {% endif %}
                </div>
            {% endif %}
        </div>

        <!-- Acciones administrativas -->
        <div class="status-section slide-in" id="admin-actions">
            <div class="action-buttons">
                <button type="button" class="btn btn-accept" id="btn-accept" data-video-id="{{ video.id }}">
                    <i class="fas fa-check-circle"></i> Marcar como aceptado
                </button>
                <button type="button" class="btn btn-reject" id="btn-reject" data-video-id="{{ video.id }}">
                    <i class="fas fa-times-circle"></i> Rechazar video
                </button>
            </div>
        </div>

        <div style="text-align: center;">
            <a href="{{ url_for('main.listado_videos') }}" class="back-link">
                <i class="fas fa-arrow-left"></i> Volver al listado
            </a>
        </div>
    </div>

    <script>
        const videoId = {{ video.id }};
        window.currentEstado = "{{ video.estado }}";
    </script>
    <script src="{{ url_for('static', filename='js/admin_detalle.js') }}"></script>
</body>
</html>